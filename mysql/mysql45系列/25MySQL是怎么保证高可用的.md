## 25|MySQL是怎么保证高可用的？

开头又放了一次双M：

![双M](D:\developer\whatidread\mysql\mysql45系列\MySQL主备切换流程--双M结构.png)



### 主备延迟

主备延迟：主库A执行完一个事务T1之后，到备库B执行完同样的事务T3之后的间隔实践：T3-T1。

可以用 show slave status，看seconds_behind_matser参数查看延迟了多少秒。

主备延迟的直接表现是：备库消费relaylog的速度，比主库生产binlog的速度要慢。



### 主备延迟的来源

首先，有些部署条件下， 备库所在机器的性能要比主句所在的机器性能差，亦或是把多个备库放在一台机器上；更新请求对于主库和备库的IOPS实际上是无差别的，多个备库在一台机器上，可能会造成资源争抢。

一般都用对称部署。

对称部署情况下，如果备库压力过大，也可能造成主备延迟。比如备库查询消耗了大量的CPU自已按，影响同步速度这种情况；一般是使用多从部署来分担压力；如果还解决不了，建议使用外部系统，比如hadoop等；

然后一种可能，就是**大事务**，因为主库上必须等事务完成才会写入binlog，再传给备库。**不要一次性用detele删太多数据**，这就是典型的大事务场景。

另一种典型大事务场景，就是大表DDL。

造成主备延迟，还有一个大方向原因，就是备库的并行复制能力。



由于主备延迟的存在，再做主备切换的时候就相应的有不同的策略：

### 可靠性优先策略

以双M结构为例：

1. 判断备库B现在的seconds_behind_master，如果小于某个值（比如5s）继续下一步，否则持续重试这一步；
2. 把主库A改成只读状态，即把read_only设置为true；
3. 判断备库B现在的seconds_behind_master，直到为0；
4. 备库改成可读写状态，readonly设置为false；
5. 把业务请求切换到B；

这个切换流程一般使用HA系统来完成，主要看还是看架构部署情况；

### 可用性优先策略

如果强行把上面的4、5调整到最开始执行，那么系统几乎没有不可用时间；但这有可能导致数据不一致的情况。（一般主键冲突的情况较多）



至于那种策略，主要还是要看业务场景和数据库的运行情况；



### 小结

- 主备延迟是怎么算的，算t3-t1；
- 主备延迟的几种来源，备库压力过大，大事务，大表DDL等
- 主备切换的两种常见策略，可靠性优先，可用性优先，主要看业务场景