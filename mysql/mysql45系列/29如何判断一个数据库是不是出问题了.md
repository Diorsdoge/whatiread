## 29|如何判断一个数据库是不是出问题了？

这一章讲讲：怎么按段一个主库出问题了？



### select 1判断

连上数据库，执行select 1就行；

但能检查出来一些，无法检查全部：

innodb_thread_concurrency设置为n，表示只允许n个线程并行执行；默认为0，不限制。在show processlist里面，能看到的全部叫并发连接，而“当前正在执行的”语句，才是并发查询。

在线程进入锁等待之后，并发线程的计数会减一。

如果innodb_thread_concurrency满了，实际上已经不能正常运行了，但select 1还是可以的。那这个判断就不准确；



### 查表判断

为解决上面问题，可以在系统库创建一个表，比如mysql.health_check，里面只放一行数。然后使用 `SELECT * FROM MYSQL.HEALTH_CHECK`来检查数据库的可用性。

但如果是空间满了，数据库依然可以正常读数据，但所有的更新语句和事务提交语句都会被堵住。这个判断也就又不准确了。



### 更新判断

在表中放一个有意义的字段，例如timestamp，每次检查都执行一个更新语句：

```mysql
update mysql.health_check set t_modified=now();
```

如果是双M，规定了server_id是不同的，所以各自的检测命令并不会冲突；

但是“慢”这个问题，依然很难判定；



### 内部统计

在MySQL内部发现数据库问题的方法

MySQL 5.6后提供了performance_schema库，file_summary_by_event表里面统计了每次IO请求时间。从里面的文件中获取各种信息用于监控，比如redo log的操作时间统计等。

打开这个统计功能是有消耗的，作者测试了一下，打开所有的performance_schema项，性能会下降10%；



### 小结

- select 1判断，简单，但只能判断出数据库可以正常连上；
- 创建表，查询判断，无法判断磁盘满了场景；
- 创建表，更新判断，无法判断延迟场景；
- 使用内部统计，会影响数据库性能；
- 前面三个可以采用拨测，后面那个用上报的数据进行计算会好点；