## 12|为什么我的“MySQL”会抖一下？

有时候我们会遇到同一条SQL，正常执行的时候特别快，但有时候却非常慢，并且难以复现，不止随机出现，而且时间还很短。看上去是抖了一下。

### 你的SQL语句为什么变”慢“了

当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为”脏页“。内存数据写入磁盘后，而二者便一致了，称为”干净页“。

回到开头，平时很快的时候很可能是在些内存和日志，而”抖“那一下的瞬间，可能就是在刷脏页（flush）。

什么时候引发flush呢？

- 第一种场景，粉板满了，记不下账了，需要把之前正确的账目记录到帐本中；即redo log 写满了，这个时候会把checkpoint往前推，留出更多的空间继续写，此时会把推送的部分全部flush到磁盘上，才能继续写入redo log；
- 第二种场景，这天生意太好，要记住的事情太多，掌柜发现自己粉板快记不住了，赶紧找出账本先加进去。这个时候对应的情况就是系统内存不足，需要淘汰掉一些数据页，空出来的数据页给别的数据页用。如果淘汰的是脏页，就要先把脏页写入磁盘。如果刷脏页一定会写盘，就保证了每个数据页有两种状态：
  - 一种是在内存里存在，内存里就肯定是正确结果，直接返回；
  - 一种是内存里没有数据，就可以肯定数据文件上是正确的结果，读入内存后返回。这种效率最高。
- 第三种场景，生意不忙的时候，或者打烊之后。这时候柜台没事儿，掌柜闲着也是闲着，不如更新账本。MySQL认为系统”空闲“的时候。
- 第四个场景，年底要关门几天，需要把账结清，这时候掌柜就要会把所有账都计入账本上。对应了MySQL正常关闭的时候，会把内存脏页都flush到磁盘上。

第三种情况属于数据库空闲，第四种情况属于正常关闭，一般情况下不太关注”性能“问题。所以作者这里主要将第一二种情况。

第一种是”redo log写满了，要flush脏页“，这种情况InnoDB要尽量避免，因为这个时候整个系统就不能再接受更新了，从监控上来看，更新数会跌为0；

第二种是”内存不够用了，要先将脏页写到磁盘“，这种情况其实是常态。**InnoDB用缓冲池（buffer pool）管理内存，缓存池种的内存页有三种状态：**

- 没有使用的
- 使用了且是干净页
- 使用了且是脏页

InnoDB的策略是尽量使用内存，因此对于一个长时间运行的库来说，未被使用的页面很少。

当要读入数据页没有在内存的时候，就必须到缓存种申请一个数据页，这个时候会把最久不使用的页从内存种淘汰出来；如果淘汰的是干净页，则释放出来直接用；如果是脏页，就必须先刷到磁盘变成干净页了，才能复用。以下两种情况，会明显影响性能：

1. 一个查询要淘汰的脏页个数太多，会导致查询的相应时间明显变长；
2. 日志写满，更新全部堵住，写性能跌为0，这种情况是不可接受的。

所以InnoDB需要有控制脏页比例的机制，来尽量避免上面的这两种情况。



### InnoDB刷脏页的控制策略

首先可以通过设置`innodb_io_capacity`参数来告诉InnoDB你的磁盘能力。建议设置为磁盘的IOPS。可以通过fio这个工具来测试。

```shell
fio -filename=$filename -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -numjobs=10 -runtime=10 -group_reporting -name=mytest
```

因为如果没有正确设置好这个参数，而导致的性能问题也比比皆是。比如如果设置太小，InnoDB会认为你的机器不太行，所以刷得特别慢。

InnoDB刷盘速度要参考两个因素：脏页比例，redo log写盘速度；

参数`innodb_max_dirty_pages_pct`是脏页比例上限，默认为75%。InnoDB会根据当前得脏页比例(假设为M)，算出一个范围在0到100之间得数。InnoDB每次写入的日志都有一个序号，当前写入的序号跟checkpoint对应的序号之间的差值，假设为N。计算出一个范围在0到100的数字，其中N越大，算出来的值越大。

**然后根据F1(M)和F2(N)两个值，取其中最大的值记作R，之后引擎就可以按照innodb_io_capacity定义的能力乘以R%来控制刷脏页的速度。**

所以，无论是查询语句需要内存的时候可能要求淘汰脏页，还是刷脏页的逻辑会占用IO都会影响到更新语句。都可能是抖一下的原因。

要尽量避免这种情况，要合理设置innodb_io_capacity的值，并且平时要多关注脏页比例，不要让它经常接近75%。(innodb_buffer_pool_pages_dirty/innodb_buffer_pool_pages_total)

innodb_flush_neighbors参数能控制是否需要把”邻居“脏页一起刷盘。值为1，一起刷；为0，自己刷自己的，不管邻居。

在MySQL8.0中，默认为0。



### 小结

- 四个场景，实际上都与刷盘有关；抖一下，大概率是刷盘导致；
- innodb_io_capacity要设置合理，它告诉InnoDB机器的刷盘能力，建议设置为IOPS，使用fio工具测出来；
- 避免脏页比例超过75%；



问题：其他正常的情况下，redo被设置为1个100MB的文件了，会发生什么情况？

答：会导致redo很快被写满，write pos一直追着checkpoint。这个时候系统会停止更新，去推进checkpoint。现象为：磁盘压力很小，但数据库出现间歇性性能下降。

