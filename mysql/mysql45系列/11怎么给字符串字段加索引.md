## 11|怎么给字符串字段加索引？

假设一个支持邮箱登录的系统：

```mysql
create table SUser (
	ID bigint usigned primary key,
    email varchar(64),
    ...
)engine=innodb;
```

由于要使用邮箱登录，业务会出现这样的语句：

```mysql
select f1, f2 from SUser where email='xxx';
```

如果不在email上加索引，会走全表扫描。

MySQL是支持前缀索引的，我们可以定义字符串的一部分作为索引。默认的，不指定前缀长度，则为整个字符串。

```mysql
alter table SUser add index index1(email);  -- 取整个字符串 -- 
alter table SUser add index index2(email(6)); -- 取六个字节
```

区别是：使用index1只需要回表1次，扫描一行数据；使用index2可能需要回表的次数变多，需要扫描的行数也可能变多，但占用的空间会更小。

如果比较合理的利用定义index2的长度，做到索引规定字节范围内尽量不重复，旧可以做到既节省空间，又不需用额外的增加太多查询成本。

创建索引时，关注的还是区分度，区分度越高越好。因此，可以通过统计来判断需要使用多长的前缀。



### 前缀索引对覆盖索引的影响

比如

```MYSQL
select id, email from SUser where email='avadadasd@qq.com';
```

这个语句只需要id和email，如果使用index1，就不用回表；如果使用index2就不得不回表，但实际上即便是index2的前缀已经包含了完整的email长度，也会回表去查。所以使用前缀索引就用不上覆盖索引对查询性能的优化了。



### 其他方式

前缀索引区分度都不好的情况，比如身份证，前六位是地址码，相同概率很大，中间八位是生日，可能需要创建12字节以上的前缀，区分度才能达到要求，但使用的空间也很大了。

第一种方式：倒序存储。把身份证倒过来存，以提高区分度，取数据的时候使用reverse()函数。

第二种方式：使用hash字段。在表上再创建一个字段来保存身份证的校验码，同时在这个字段上添加索引。

- 从占用空间来看，倒序的一般也得6个字节以上；而hash使用4个字节，但会增加一个字段；这方面看差别不大；
- 从cpu消耗来看，reverse函数额外消耗的cpu资源会稍小些；
- 从查询效率来看，hash字段的冲突更小，回表次数更小，扫描行数更少；倒序存储也是前缀索引，所以回表次数会更高一些。



### 小结

- 前缀索引，尽量提高区分度；
- 前缀索引没法使用覆盖索引的方式取值；
- 倒序存储和hash字段来创建索引；
- **尽量提高区分度，并且尽量减少空间使用**





