## 15|答疑文章（一）：日志和索引相关问题

> 这是个答疑得文章

### 日志相关问题

崩溃恢复时的判断规则：

1. 如果redo log里面的事务是完整的，也就是有了commit标识，则直接提交；
2. 如果redo log里面只有完整的prepare，则判断对应的事务binlog是否存在并完整；
   - 如果是，则提交事务；
   - 如果不是，回滚事务；

### 追问1：MySQL怎么知道binlog是完整的？

回答：一个事务的binlog格式为：

- statement格式binlog，最后会有commit；
- row格式的binlog，最后会有一个xid event；
- 5.6.2版本后，引入binlog-checksum参数，验证binlog内容的正确性

### 追问2： redo log和binlog怎么关联起来的？

回答：有个共同数据字段，XID。崩溃恢复的时候，如果redo只有prepare，则拿着XID去找binlog中对应的事务。

### 追问3：处于prepare阶段的redo log加上完整的binlog，重启就能恢复，MySQL为什么要这么设计？

回答：主要是为了主从同步，主从同步靠binlog；保证主库和备库的数据一致性；

### 追问4：如果这样的话，为什么还要两阶段提交呢，干脆先redo log写完，再写binlog。崩溃恢复的时候，必须得两个日志都完成才可以。是不是一样的逻辑？

回答：两阶段提交是经典的分布式系统问题，不是MySQL特有。两阶段提交就是给所有人一个机会，当每个人都说ok，再一起提交。如果redo提交完成了，事务就不能回滚了。redo 提价完成了，binlog又提交失败，导致主从又不一致了。

### 追问5：不引入两个日志，也就没有两阶段提交的必要了。只用binlog来支持崩溃恢复，又能归档，不就可以了？

回答：不可以。InnoDB不是MySQL原生存储引擎，原生存储引擎是MyISAM，设计之初并未支持崩溃恢复。就InnoDB引擎而言，binlog无法恢复数据页。

### 追问6：拿能不能反过来，只用redo log，不用binlog？

回答：如果从崩溃恢复的角度是可以的，但主从一致性会又问题，第三方对binlog的使用也会有问题。

### 追问7：redo log一般设置多大？

回答：太小，会导致很快写满，然后然后不得不强制刷盘，这样WAL机制的能力发挥不出来。对于几个T磁盘的，设置redo log为4个文件，一个文件1GB吧。

### 追问8：正常运行中的实例，数据写入后的最终落盘，是从redo log更新过来的，还是从buffer pool更新过来的呢？

回答：redo log只会把内存页变为脏页，还是得靠刷盘，或者读取来更新。

### 追问9：redo log buffer是什么？是先修改内存，还是先写redo log文件？

回答：redo log buffer就是一块内存，用来先存redo 日志的，事务刚开始更新语句的时候就开始写。真正把日志写到redo log文件的时候，是事务在commit的时候。



### 业务设计问题

该用唯一索引的还是要用唯一索引。尽量使用普通普通索引，是建立在”业务开发保证不会插入重复记录“的时候。



### 小结

- 都是问题，没啥好结的

